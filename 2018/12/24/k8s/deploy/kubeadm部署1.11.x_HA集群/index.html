<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css">


  <meta name="keywords" content="k8s,kubeadm,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2">






<meta name="description" content="1 实验环境说明实验环境lab1: etcd master haproxy keepalived 10.7.12.201lab2: etcd master haproxy keepalived 10.7.12.202lab3: etcd master haproxy keepalived 10.7.12.203lab4: node  10.7.12.204 同时lab1-lab3 部署了ceph集">
<meta name="keywords" content="k8s,kubeadm">
<meta property="og:type" content="article">
<meta property="og:title" content="kubeadm部署1.11.x_HA集群">
<meta property="og:url" content="http://liupeng0518.github.io/2018/12/24/k8s/deploy/kubeadm部署1.11.x_HA集群/index.html">
<meta property="og:site_name" content="Life is short, you need Python">
<meta property="og:description" content="1 实验环境说明实验环境lab1: etcd master haproxy keepalived 10.7.12.201lab2: etcd master haproxy keepalived 10.7.12.202lab3: etcd master haproxy keepalived 10.7.12.203lab4: node  10.7.12.204 同时lab1-lab3 部署了ceph集">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-06-14T17:19:06.984Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kubeadm部署1.11.x_HA集群">
<meta name="twitter:description" content="1 实验环境说明实验环境lab1: etcd master haproxy keepalived 10.7.12.201lab2: etcd master haproxy keepalived 10.7.12.202lab3: etcd master haproxy keepalived 10.7.12.203lab4: node  10.7.12.204 同时lab1-lab3 部署了ceph集">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://liupeng0518.github.io/2018/12/24/k8s/deploy/kubeadm部署1.11.x_HA集群/">





  <title>kubeadm部署1.11.x_HA集群 | Life is short, you need Python</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-155243829-1', 'auto');
  ga('send', 'pageview');
</script>











<link rel="alternate" href="/atom.xml" title="Life is short, you need Python" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Life is short, you need Python</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Peng Liu`s Blog</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://liupeng0518.github.io/2018/12/24/k8s/deploy/kubeadm部署1.11.x_HA集群/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Peng Liu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/ingress.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Life is short, you need Python">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">kubeadm部署1.11.x_HA集群</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-24T09:47:19+00:00">
                2018-12-24
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index">
                    <span itemprop="name">k8s</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-实验环境说明"><a href="#1-实验环境说明" class="headerlink" title="1 实验环境说明"></a>1 实验环境说明</h1><p>实验环境<br>lab1: etcd master haproxy keepalived 10.7.12.201<br>lab2: etcd master haproxy keepalived 10.7.12.202<br>lab3: etcd master haproxy keepalived 10.7.12.203<br>lab4: node  10.7.12.204</p>
<p>同时lab1-lab3 部署了ceph集群</p>
<p>vip(loadblancer ip): 10.7.12.200</p>
<h1 id="2-基础环境配置"><a href="#2-基础环境配置" class="headerlink" title="2 基础环境配置"></a>2 基础环境配置</h1><h2 id="2-1-安装docker"><a href="#2-1-安装docker" class="headerlink" title="2.1 安装docker"></a>2.1 安装docker</h2><p>v1.11.x版本推荐使用docker v17.03,配置国内docker源（daocloud或者aliyun）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils</span><br><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">     https://download.daocloud.io/docker/linux/centos/docker-ce.repo</span><br><span class="line">sudo yum install -y -q --setopt=obsoletes=0 docker-ce-17.03.2.ce* docker-ce-selinux-17.03.2.ce*</span><br><span class="line">sudo systemctl enable docker</span><br><span class="line">sudo systemctl start docker</span><br><span class="line">sudo service docker status</span><br></pre></td></tr></table></figure></p>
<h2 id="2-2-配置国内-docker-镜像加速器"><a href="#2-2-配置国内-docker-镜像加速器" class="headerlink" title="2.2 配置国内 docker 镜像加速器"></a>2.2 配置国内 docker 镜像加速器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 加速镜像下载（或者配置aliyun）</span><br><span class="line">curl -sSL https://get.daocloud.io/daotools/set_mirror.sh | sh -s http://xxx(个人账户).m.daocloud.io</span><br></pre></td></tr></table></figure>
<h2 id="2-3-安装-kube-所有节点"><a href="#2-3-安装-kube-所有节点" class="headerlink" title="2.3 安装 kube* (所有节点)"></a>2.3 安装 kube* (所有节点)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 配置源,使用阿里镜像安装</span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 安装</span><br><span class="line">yum install -y kubelet kubeadm kubectl ipvsadm</span><br></pre></td></tr></table></figure>
<h2 id="2-4-基础系统参数配置"><a href="#2-4-基础系统参数配置" class="headerlink" title="2.4 基础系统参数配置"></a>2.4 基础系统参数配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># 关闭 selinux</span><br><span class="line">sed -i &apos;s/SELINUX=permissive/SELINUX=disabled/&apos; /etc/sysconfig/selinux</span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"># 关闭swap</span><br><span class="line"># 注释/etc/fstab文件里swap相关的行并执行:</span><br><span class="line">swapoff -a</span><br><span class="line">​</span><br><span class="line"># 配置转发相关参数，否则可能会出错</span><br><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">vm.swappiness=0</span><br><span class="line">EOF</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"># 开启forward, Docker从1.13版本开始调整了默认的防火墙规则</span><br><span class="line"># 禁用了iptables filter表中FOWARD链, 这样会导致Kubernetes集群中跨Node的Pod无法通信</span><br><span class="line">iptables -P FORWARD ACCEPT</span><br><span class="line"></span><br><span class="line"># 加载ipvs相关内核模块</span><br><span class="line">modprobe ip_vs</span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe ip_vs_wrr</span><br><span class="line">modprobe ip_vs_sh</span><br><span class="line">modprobe nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line">lsmod | grep ip_vs</span><br><span class="line"></span><br><span class="line"># 开机生效</span><br><span class="line">cat &gt;&gt;/etc/rc.local&lt;EOF</span><br><span class="line">modprobe ip_vs</span><br><span class="line">modprobe ip_vs_rr</span><br><span class="line">modprobe ip_vs_wrr</span><br><span class="line">modprobe ip_vs_sh</span><br><span class="line">modprobe nf_conntrack_ipv4</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod +x /etc/rc.local</span><br><span class="line"></span><br><span class="line"># 配置hosts解析</span><br><span class="line"></span><br><span class="line">cat &gt;&gt;/etc/hosts&lt;&lt;EOF</span><br><span class="line">10.7.12.201 lab1</span><br><span class="line">10.7.12.202 lab2</span><br><span class="line">10.7.12.203 lab3</span><br><span class="line">10.7.12.204 lab4</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h1 id="3-高可用组件配置"><a href="#3-高可用组件配置" class="headerlink" title="3 高可用组件配置"></a>3 高可用组件配置</h1><p>配置haproxy和keepalived，这里我们选取了lab1-lab3三台机器，作为 haproxy+keepalived 集群， 为k8s集群提供vip服务（高可用服务），此章节需要在节点lab1,lab2,lab3操作</p>
<h2 id="3-1-haproxy配置"><a href="#3-1-haproxy配置" class="headerlink" title="3.1 haproxy配置"></a>3.1 haproxy配置</h2><h3 id="拉取镜像并修改haproxy配置"><a href="#拉取镜像并修改haproxy配置" class="headerlink" title="拉取镜像并修改haproxy配置"></a>拉取镜像并修改haproxy配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取haproxy镜像</span></span><br><span class="line">docker pull haproxy:1.7.8-alpine</span><br><span class="line">mkdir /etc/haproxy</span><br><span class="line">cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;EOF</span><br><span class="line">global</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  <span class="comment">#daemon</span></span><br><span class="line">  nbproc 1</span><br><span class="line">  pidfile haproxy.pid</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  maxconn 50000</span><br><span class="line">  retries 3</span><br><span class="line">  timeout connect 5s</span><br><span class="line">  timeout client 30s</span><br><span class="line">  timeout server 30s</span><br><span class="line">  timeout check 2s</span><br><span class="line"></span><br><span class="line">listen admin_stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:1080</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local0 err</span><br><span class="line">  stats refresh 30s</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats realm   Haproxy\ Statistics</span><br><span class="line">  stats auth    samuel:samuel</span><br><span class="line">  stats hide-version</span><br><span class="line">  stats admin <span class="keyword">if</span> TRUE</span><br><span class="line"></span><br><span class="line">frontend k8s-https</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:8443</span><br><span class="line">  mode tcp</span><br><span class="line">  <span class="comment">#maxconn 50000</span></span><br><span class="line">  default_backend k8s-https</span><br><span class="line"></span><br><span class="line">backend k8s-https</span><br><span class="line">  mode tcp</span><br><span class="line">  balance roundrobin</span><br><span class="line">  server lab1 10.7.12.201:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">  server lab2 10.7.12.202:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">  server lab3 10.7.12.203:6443 weight 1 maxconn 1000 check inter 2000 rise 2 fall 3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="启动并查看服务状态"><a href="#启动并查看服务状态" class="headerlink" title="启动并查看服务状态"></a>启动并查看服务状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动haproxy</span></span><br><span class="line">docker run -d --name k8s-haproxy \</span><br><span class="line">-v /etc/haproxy:/usr/<span class="built_in">local</span>/etc/haproxy:ro \</span><br><span class="line">-p 8443:8443 \</span><br><span class="line">-p 1080:1080 \</span><br><span class="line">--restart always \</span><br><span class="line">haproxy:1.7.8-alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看日志</span></span><br><span class="line">docker logs my-haproxy</span><br><span class="line"></span><br><span class="line"><span class="comment"># 浏览器查看状态</span></span><br><span class="line">http://10.7.12.201:1080/haproxy-status</span><br><span class="line">http://10.7.12.202:1080/haproxy-status</span><br></pre></td></tr></table></figure>
<h2 id="3-2-keepalived-配置"><a href="#3-2-keepalived-配置" class="headerlink" title="3.2 keepalived 配置"></a>3.2 keepalived 配置</h2><p>这里选取osixia维护的keepalived镜像</p>
<h3 id="拉取并启动服务"><a href="#拉取并启动服务" class="headerlink" title="拉取并启动服务"></a>拉取并启动服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拉取keepalived镜像</span></span><br><span class="line">docker pull osixia/keepalived:1.4.4</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动keepalived</span></span><br><span class="line"><span class="comment"># eth0为本次实验网段的所在网卡</span></span><br><span class="line">docker run --net=host --<span class="built_in">cap</span>-add=NET_ADMIN \</span><br><span class="line">-e KEEPALIVED_INTERFACE=eth0 \</span><br><span class="line">-e KEEPALIVED_VIRTUAL_IPS=<span class="string">"#PYTHON2BASH:['10.7.12.200']"</span> \</span><br><span class="line">-e KEEPALIVED_UNICAST_PEERS=<span class="string">"#PYTHON2BASH:['10.7.12.201','10.7.12.202','10.7.12.203']"</span> \</span><br><span class="line">-e KEEPALIVED_PASSWORD=hello \</span><br><span class="line">--name k8s-keepalived \</span><br><span class="line">--restart always \</span><br><span class="line">-d osixia/keepalived:1.4.4</span><br></pre></td></tr></table></figure>
<h3 id="查看keepalived服务状态"><a href="#查看keepalived服务状态" class="headerlink" title="查看keepalived服务状态"></a>查看keepalived服务状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看日志，会看到两个成为backup 一个成为master</span></span><br><span class="line">docker logs k8s-keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时会配置 10.7.12.200 到其中一台机器，ping测试</span></span><br><span class="line">ping -c4 10.7.12.200</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果失败后，清理并重新部署</span></span><br><span class="line">docker rm -f k8s-keepalived</span><br><span class="line">ip a del 10.7.12.200/32 dev eth0</span><br></pre></td></tr></table></figure>
<h1 id="4-配置启动kubelet"><a href="#4-配置启动kubelet" class="headerlink" title="4 配置启动kubelet"></a>4 配置启动kubelet</h1><p>如下操作在所有节点操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置kubelet使用国内pause镜像</span></span><br><span class="line"><span class="comment"># 配置kubelet的cgroups</span></span><br><span class="line"><span class="comment"># 获取docker的cgroups</span></span><br><span class="line">DOCKER_CGROUPS=$(docker info | grep <span class="string">'Cgroup'</span> | cut -d<span class="string">' '</span> -f3)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$DOCKER_CGROUPS</span></span><br><span class="line">cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF</span><br><span class="line">KUBELET_EXTRA_ARGS=<span class="string">"--cgroup-driver=<span class="variable">$DOCKER_CGROUPS</span> --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.1"</span></span><br><span class="line">EOF</span><br><span class="line">​</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl restart kubelet</span><br></pre></td></tr></table></figure></p>
<h1 id="5-部署集群"><a href="#5-部署集群" class="headerlink" title="5 部署集群"></a>5 部署集群</h1><p>配置master节点</p>
<h2 id="5-1-配置第一个master节点"><a href="#5-1-配置第一个master节点" class="headerlink" title="5.1 配置第一个master节点"></a>5.1 配置第一个master节点</h2><p>如下操作在lab1节点操作</p>
<h3 id="生成-kubeadm-需要的配置文件"><a href="#生成-kubeadm-需要的配置文件" class="headerlink" title="生成 kubeadm 需要的配置文件"></a>生成 kubeadm 需要的配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.11.0 版本 centos 下使用 ipvs 模式会出问题</span></span><br><span class="line"><span class="comment"># 参考 https://github.com/kubernetes/kubernetes/issues/65461</span></span><br><span class="line"><span class="comment"># 1.11.1 之后的版本已经修复了，这里部署使用的是ipvs</span></span><br><span class="line"><span class="comment"># 生成配置文件</span></span><br><span class="line"></span><br><span class="line">CP0_IP=<span class="string">"10.7.12.201"</span></span><br><span class="line">CP0_HOSTNAME=<span class="string">"lab1"</span></span><br><span class="line">cat &gt;kubeadm-master.config&lt;&lt;EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.0</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- <span class="string">"lab1"</span></span><br><span class="line">- <span class="string">"lab2"</span></span><br><span class="line">- <span class="string">"lab3"</span></span><br><span class="line">- <span class="string">"10.7.12.201"</span></span><br><span class="line">- <span class="string">"10.7.12.202"</span></span><br><span class="line">- <span class="string">"10.7.12.203"</span></span><br><span class="line">- <span class="string">"10.7.12.200"</span></span><br><span class="line">- <span class="string">"127.0.0.1"</span></span><br><span class="line"></span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: <span class="variable">$CP0_IP</span></span><br><span class="line">  controlPlaneEndpoint: 10.7.12.200:8443</span><br><span class="line"></span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: <span class="string">"https://127.0.0.1:2379,https://<span class="variable">$CP0_IP</span>:2379"</span></span><br><span class="line">      advertise-client-urls: <span class="string">"https://<span class="variable">$CP0_IP</span>:2379"</span></span><br><span class="line">      listen-peer-urls: <span class="string">"https://<span class="variable">$CP0_IP</span>:2380"</span></span><br><span class="line">      initial-advertise-peer-urls: <span class="string">"https://<span class="variable">$CP0_IP</span>:2380"</span></span><br><span class="line">      initial-cluster: <span class="string">"<span class="variable">$CP0_HOSTNAME</span>=https://<span class="variable">$CP0_IP</span>:2380"</span></span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - <span class="variable">$CP0_HOSTNAME</span></span><br><span class="line">      - <span class="variable">$CP0_IP</span></span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - <span class="variable">$CP0_HOSTNAME</span></span><br><span class="line">      - <span class="variable">$CP0_IP</span></span><br><span class="line"></span><br><span class="line">controllerManagerExtraArgs:</span><br><span class="line">  node-monitor-grace-period: 10s</span><br><span class="line">  pod-eviction-timeout: 10s</span><br><span class="line"></span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line"></span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    <span class="comment"># mode: ipvs</span></span><br><span class="line">    mode: iptables</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提前拉取镜像</span></span><br><span class="line"><span class="comment"># 如果执行失败 可以多次执行</span></span><br><span class="line">kubeadm config images pull --config kubeadm-master.config</span><br><span class="line">​</span><br><span class="line"><span class="comment"># 初始化</span></span><br><span class="line"><span class="comment"># 注意保存返回的 join 命令</span></span><br><span class="line">kubeadm init --config kubeadm-master.config</span><br></pre></td></tr></table></figure>
<p>初始化结束之后，按照提示，配置kube config</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm -rf <span class="variable">$HOME</span>/.kube</span><br><span class="line">mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>
<p>同时，这里会提示部署网路插件，这里放在第6步操作</p>
<h3 id="打包ca证书到其他master节点"><a href="#打包ca证书到其他master节点" class="headerlink" title="打包ca证书到其他master节点"></a>打包ca证书到其他master节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 打包ca相关文件上传至其他master节点</span><br><span class="line">cd /etc/kubernetes &amp;&amp; tar cvzf k8s-key.tgz admin.conf pki/ca.* pki/sa.* pki/front-proxy-ca.* pki/etcd/ca.*</span><br><span class="line">scp k8s-key.tgz lab2:~/</span><br><span class="line">scp k8s-key.tgz lab3:~/</span><br><span class="line">ssh lab2 &apos;tar xf k8s-key.tgz -C /etc/kubernetes/&apos;</span><br><span class="line">ssh lab3 &apos;tar xf k8s-key.tgz -C /etc/kubernetes/&apos;</span><br></pre></td></tr></table></figure>
<h2 id="5-2-配置第二个master节点"><a href="#5-2-配置第二个master节点" class="headerlink" title="5.2 配置第二个master节点"></a>5.2 配置第二个master节点</h2><p>如下操作在lab2节点操作</p>
<h3 id="生成-kubeadm-需要的配置文件-1"><a href="#生成-kubeadm-需要的配置文件-1" class="headerlink" title="生成 kubeadm 需要的配置文件"></a>生成 kubeadm 需要的配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成配置文件</span></span><br><span class="line">CP0_IP=<span class="string">"10.7.12.201"</span></span><br><span class="line">CP0_HOSTNAME=<span class="string">"lab1"</span></span><br><span class="line">CP1_IP=<span class="string">"10.7.12.202"</span></span><br><span class="line">CP1_HOSTNAME=<span class="string">"lab2"</span></span><br><span class="line">cat &gt;kubeadm-master.config&lt;&lt;EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.0</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- <span class="string">"lab1"</span></span><br><span class="line">- <span class="string">"lab2"</span></span><br><span class="line">- <span class="string">"lab3"</span></span><br><span class="line">- <span class="string">"10.7.12.201"</span></span><br><span class="line">- <span class="string">"10.7.12.202"</span></span><br><span class="line">- <span class="string">"10.7.12.203"</span></span><br><span class="line">- <span class="string">"10.7.12.200"</span></span><br><span class="line">- <span class="string">"127.0.0.1"</span></span><br><span class="line"></span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: <span class="variable">$CP1_IP</span></span><br><span class="line">  controlPlaneEndpoint: 10.7.12.200:8443</span><br><span class="line"></span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: <span class="string">"https://127.0.0.1:2379,https://<span class="variable">$CP1_IP</span>:2379"</span></span><br><span class="line">      advertise-client-urls: <span class="string">"https://<span class="variable">$CP1_IP</span>:2379"</span></span><br><span class="line">      listen-peer-urls: <span class="string">"https://<span class="variable">$CP1_IP</span>:2380"</span></span><br><span class="line">      initial-advertise-peer-urls: <span class="string">"https://<span class="variable">$CP1_IP</span>:2380"</span></span><br><span class="line">      initial-cluster: <span class="string">"<span class="variable">$CP0_HOSTNAME</span>=https://<span class="variable">$CP0_IP</span>:2380,<span class="variable">$CP1_HOSTNAME</span>=https://<span class="variable">$CP1_IP</span>:2380"</span></span><br><span class="line">      initial-cluster-state: existing</span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - <span class="variable">$CP1_HOSTNAME</span></span><br><span class="line">      - <span class="variable">$CP1_IP</span></span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - <span class="variable">$CP1_HOSTNAME</span></span><br><span class="line">      - <span class="variable">$CP1_IP</span></span><br><span class="line"></span><br><span class="line">controllerManagerExtraArgs:</span><br><span class="line">  node-monitor-grace-period: 10s</span><br><span class="line">  pod-eviction-timeout: 10s</span><br><span class="line"></span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line"></span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    <span class="comment"># mode: ipvs</span></span><br><span class="line">    mode: iptables</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="配置kubelet"><a href="#配置kubelet" class="headerlink" title="配置kubelet"></a>配置kubelet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha phase certs all --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config kubeadm-master.config</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h3 id="添加etcd到集群中"><a href="#添加etcd到集群中" class="headerlink" title="添加etcd到集群中"></a>添加etcd到集群中</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CP0_IP=<span class="string">"10.7.12.201"</span></span><br><span class="line">CP0_HOSTNAME=<span class="string">"lab1"</span></span><br><span class="line">CP1_IP=<span class="string">"10.7.12.202"</span></span><br><span class="line">CP1_HOSTNAME=<span class="string">"lab2"</span></span><br><span class="line">KUBECONFIG=/etc/kubernetes/admin.conf kubectl <span class="built_in">exec</span> -n kube-system etcd-<span class="variable">$&#123;CP0_HOSTNAME&#125;</span> -- etcdctl --ca-file /etc/kubernetes/pki/etcd/ca.crt --cert-file /etc/kubernetes/pki/etcd/peer.crt --key-file /etc/kubernetes/pki/etcd/peer.key --endpoints=https://<span class="variable">$&#123;CP0_IP&#125;</span>:2379 member add <span class="variable">$&#123;CP1_HOSTNAME&#125;</span> https://<span class="variable">$&#123;CP1_IP&#125;</span>:2380</span><br><span class="line">kubeadm alpha phase etcd <span class="built_in">local</span> --config kubeadm-master.config</span><br></pre></td></tr></table></figure>
<h3 id="配置master加入集群"><a href="#配置master加入集群" class="headerlink" title="配置master加入集群"></a>配置master加入集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提前拉取镜像, 可多次执行</span></span><br><span class="line">kubeadm config images pull --config kubeadm-master.config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 部署</span></span><br><span class="line">kubeadm alpha phase kubeconfig all --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase controlplane all --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase mark-master --config kubeadm-master.config</span><br></pre></td></tr></table></figure>
<h2 id="5-3-配置第三个master节点"><a href="#5-3-配置第三个master节点" class="headerlink" title="5.3 配置第三个master节点"></a>5.3 配置第三个master节点</h2><h3 id="生成-kubeadm-需要的配置文件-2"><a href="#生成-kubeadm-需要的配置文件-2" class="headerlink" title="生成 kubeadm 需要的配置文件"></a>生成 kubeadm 需要的配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成配置文件</span></span><br><span class="line">CP0_IP=<span class="string">"10.7.12.201"</span></span><br><span class="line">CP0_HOSTNAME=<span class="string">"lab1"</span></span><br><span class="line">CP1_IP=<span class="string">"10.7.12.202"</span></span><br><span class="line">CP1_HOSTNAME=<span class="string">"lab2"</span></span><br><span class="line">CP2_IP=<span class="string">"10.7.12.203"</span></span><br><span class="line">CP2_HOSTNAME=<span class="string">"lab3"</span></span><br><span class="line">cat &gt;kubeadm-master.config&lt;&lt;EOF</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.11.0</span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line">apiServerCertSANs:</span><br><span class="line">- <span class="string">"lab1"</span></span><br><span class="line">- <span class="string">"lab2"</span></span><br><span class="line">- <span class="string">"lab3"</span></span><br><span class="line">- <span class="string">"10.7.12.201"</span></span><br><span class="line">- <span class="string">"10.7.12.202"</span></span><br><span class="line">- <span class="string">"10.7.12.203"</span></span><br><span class="line">- <span class="string">"10.7.12.200"</span></span><br><span class="line">- <span class="string">"127.0.0.1"</span></span><br><span class="line"></span><br><span class="line">api:</span><br><span class="line">  advertiseAddress: <span class="variable">$CP2_IP</span></span><br><span class="line">  controlPlaneEndpoint: 10.7.12.200:8443</span><br><span class="line"></span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    extraArgs:</span><br><span class="line">      listen-client-urls: <span class="string">"https://127.0.0.1:2379,https://<span class="variable">$CP2_IP</span>:2379"</span></span><br><span class="line">      advertise-client-urls: <span class="string">"https://<span class="variable">$CP2_IP</span>:2379"</span></span><br><span class="line">      listen-peer-urls: <span class="string">"https://<span class="variable">$CP2_IP</span>:2380"</span></span><br><span class="line">      initial-advertise-peer-urls: <span class="string">"https://<span class="variable">$CP2_IP</span>:2380"</span></span><br><span class="line">      initial-cluster: <span class="string">"<span class="variable">$CP0_HOSTNAME</span>=https://<span class="variable">$CP0_IP</span>:2380,<span class="variable">$CP1_HOSTNAME</span>=https://<span class="variable">$CP1_IP</span>:2380,<span class="variable">$CP2_HOSTNAME</span>=https://<span class="variable">$CP2_IP</span>:2380"</span></span><br><span class="line">      initial-cluster-state: existing</span><br><span class="line">    serverCertSANs:</span><br><span class="line">      - <span class="variable">$CP2_HOSTNAME</span></span><br><span class="line">      - <span class="variable">$CP2_IP</span></span><br><span class="line">    peerCertSANs:</span><br><span class="line">      - <span class="variable">$CP2_HOSTNAME</span></span><br><span class="line">      - <span class="variable">$CP2_IP</span></span><br><span class="line"></span><br><span class="line">controllerManagerExtraArgs:</span><br><span class="line">  node-monitor-grace-period: 10s</span><br><span class="line">  pod-eviction-timeout: 10s</span><br><span class="line"></span><br><span class="line">networking:</span><br><span class="line">  podSubnet: 10.244.0.0/16</span><br><span class="line"></span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    <span class="comment"># mode: ipvs</span></span><br><span class="line">    mode: iptables</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="配置kubelet-1"><a href="#配置kubelet-1" class="headerlink" title="配置kubelet"></a>配置kubelet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm alpha phase certs all --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase kubelet config write-to-disk --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase kubelet write-env-file --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase kubeconfig kubelet --config kubeadm-master.config</span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<h3 id="添加etcd到集群中-1"><a href="#添加etcd到集群中-1" class="headerlink" title="添加etcd到集群中"></a>添加etcd到集群中</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CP0_IP=&quot;10.7.12.201&quot;</span><br><span class="line">CP0_HOSTNAME=&quot;lab1&quot;</span><br><span class="line">CP2_IP=&quot;10.7.12.203&quot;</span><br><span class="line">CP2_HOSTNAME=&quot;lab3&quot;</span><br><span class="line">KUBECONFIG=/etc/kubernetes/admin.conf kubectl exec -n kube-system etcd-$&#123;CP0_HOSTNAME&#125; -- etcdctl --ca-file /etc/kubernetes/pki/etcd/ca.crt --cert-file /etc/kubernetes/pki/etcd/peer.crt --key-file /etc/kubernetes/pki/etcd/peer.key --endpoints=https://$&#123;CP0_IP&#125;:2379 member add $&#123;CP2_HOSTNAME&#125; https://$&#123;CP2_IP&#125;:2380</span><br><span class="line">kubeadm alpha phase etcd local --config kubeadm-master.config</span><br></pre></td></tr></table></figure>
<h3 id="配置master加入集群-1"><a href="#配置master加入集群-1" class="headerlink" title="配置master加入集群"></a>配置master加入集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提前拉取镜像</span></span><br><span class="line">kubeadm config images pull --config kubeadm-master.config</span><br><span class="line">​</span><br><span class="line"><span class="comment"># 部署</span></span><br><span class="line">kubeadm alpha phase kubeconfig all --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase controlplane all --config kubeadm-master.config</span><br><span class="line">kubeadm alpha phase mark-master --config kubeadm-master.config</span><br></pre></td></tr></table></figure>
<h2 id="5-4-查看node节点"><a href="#5-4-查看node节点" class="headerlink" title="5.4 查看node节点"></a>5.4 查看node节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes</span><br></pre></td></tr></table></figure>
<p>只有网络插件也安装配置完成之后，才能会显示为ready状态</p>
<h2 id="5-5-设置master为可调度状态"><a href="#5-5-设置master为可调度状态" class="headerlink" title="5.5 设置master为可调度状态"></a>5.5 设置master为可调度状态</h2><p>​现在可以设置master允许部署应用pod，参与工作负载，现在可以部署其他系统组件。如 dashboard, efk等<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure></p>
<h1 id="6-网络插件部署"><a href="#6-网络插件部署" class="headerlink" title="6 网络插件部署"></a>6 网络插件部署</h1><h2 id="6-1-配置使用网络插件"><a href="#6-1-配置使用网络插件" class="headerlink" title="6.1 配置使用网络插件"></a>6.1 配置使用网络插件</h2><p>选择任意master节点操作</p>
<h2 id="6-2-下载配置"><a href="#6-2-下载配置" class="headerlink" title="6.2 下载配置"></a>6.2 下载配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir flannel &amp;&amp; <span class="built_in">cd</span> flannel</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/v0.10.0/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<h2 id="6-3-修改配置"><a href="#6-3-修改配置" class="headerlink" title="6.3 修改配置"></a>6.3 修改配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此处的ip配置要与上面kubeadm的pod-network一致</span></span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"Network"</span>: <span class="string">"10.244.0.0/16"</span>,</span><br><span class="line">      <span class="string">"Backend"</span>: &#123;</span><br><span class="line">        <span class="string">"Type"</span>: <span class="string">"vxlan"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">​</span><br><span class="line"><span class="comment"># 修改镜像</span></span><br><span class="line">image: registry.cn-shanghai.aliyuncs.com/gcr-k8s/flannel:v0.10.0-amd64</span><br><span class="line">​</span><br><span class="line"><span class="comment"># 如果Node有多个网卡的话，参考flannel issues 39701，</span></span><br><span class="line"><span class="comment"># https://github.com/kubernetes/kubernetes/issues/39701</span></span><br><span class="line"><span class="comment"># 目前需要在kube-flannel.yml中使用--iface参数指定集群主机内网网卡的名称，</span></span><br><span class="line"><span class="comment"># 否则可能会出现dns无法解析。容器无法通信的情况，需要将kube-flannel.yml下载到本地，</span></span><br><span class="line"><span class="comment"># flanneld启动参数加上--iface=&lt;iface-name&gt;</span></span><br><span class="line">    containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: registry.cn-shanghai.aliyuncs.com/gcr-k8s/flannel:v0.10.0-amd64</span><br><span class="line">        <span class="built_in">command</span>:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        - --iface=eth0</span><br></pre></td></tr></table></figure>
<h2 id="6-4-启动并查看"><a href="#6-4-启动并查看" class="headerlink" title="6.4 启动并查看"></a>6.4 启动并查看</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kube-flannel.yml</span><br><span class="line">​</span><br><span class="line">kubectl get pods --namespace kube-system</span><br><span class="line">kubectl get svc --namespace kube-system</span><br></pre></td></tr></table></figure>
<h1 id="7-添加node节点"><a href="#7-添加node节点" class="headerlink" title="7 添加node节点"></a>7 添加node节点</h1><p>我们在初始化第一个master节点的时候，返回了一个加node的命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.7.12.200:8443 --token yzb7v7.dy40mhlljt1d48i9 --discovery-token-ca-cert-hash sha256:61ec309e6f942305006e6622dcadedcc64420e361231eff23cb535a183c0e77a</span><br></pre></td></tr></table></figure></p>
<p>如果丢失或已过期可以通过如下获取加入方式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --<span class="built_in">print</span>-join-command</span><br><span class="line">或者</span><br><span class="line">token=$(kubeadm token generate)</span><br><span class="line">kubeadm token create <span class="variable">$token</span> --<span class="built_in">print</span>-join-command --ttl=0</span><br></pre></td></tr></table></figure></p>
<h1 id="8-集群基础环境测试"><a href="#8-集群基础环境测试" class="headerlink" title="8 集群基础环境测试"></a>8 集群基础环境测试</h1><p>测试容器间的通信和DNS<br>配置好网络之后，kubeadm会自动部署coredns</p>
<p>如下测试可以在配置kubectl的节点上操作</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">启动</span><br><span class="line">kubectl run nginx --replicas=2 --image=nginx:alpine --port=80</span><br><span class="line">kubectl expose deployment nginx --<span class="built_in">type</span>=NodePort --name=example-service-nodeport</span><br><span class="line">kubectl expose deployment nginx --name=example-service</span><br><span class="line">查看状态</span><br><span class="line">kubectl get deploy</span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl describe svc example-service</span><br><span class="line">DNS解析</span><br><span class="line">kubectl run curl --image=radial/busyboxplus:curl -i --tty</span><br><span class="line">nslookup kubernetes</span><br><span class="line">nslookup example-service</span><br><span class="line">curl example-service</span><br><span class="line">访问测试</span><br><span class="line"><span class="comment"># 10.96.59.56 为查看svc时获取到的clusterip</span></span><br><span class="line">curl <span class="string">"10.96.59.56:80"</span></span><br><span class="line">https://10.7.11.211:8443/api/v1/namespaces/default/services/example-service/proxy/</span><br><span class="line"><span class="comment"># 32223 为查看svc时获取到的 nodeport</span></span><br><span class="line">http://10.7.12.202:32223/</span><br><span class="line">http://10.7.12.203:32223/</span><br><span class="line">清理删除</span><br><span class="line">kubectl delete svc example-service example-service-nodeport</span><br><span class="line">kubectl delete deploy nginx curl</span><br><span class="line">高可用测试</span><br><span class="line">关闭任一master节点测试集群是能否正常执行上一步的基础测试，查看相关信息，不能同时关闭两个节点，因为3个节点组成的etcd集群，最多只能有一个当机。</span><br><span class="line"><span class="comment"># 查看组件状态</span></span><br><span class="line">kubectl get pod --all-namespaces -o wide</span><br><span class="line">kubectl get pod --all-namespaces -o wide | grep lab1</span><br><span class="line">kubectl get pod --all-namespaces -o wide | grep lab2</span><br><span class="line">kubectl get pod --all-namespaces -o wide | grep lab3</span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line">kubectl get deploy</span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl get svc</span><br><span class="line">​</span><br><span class="line"><span class="comment"># 访问测试</span></span><br><span class="line">CURL_POD=$(kubectl get pods | grep curl | grep Running | cut -d <span class="string">' '</span> -f1)</span><br><span class="line">kubectl <span class="built_in">exec</span> -ti <span class="variable">$CURL_POD</span> -- sh --tty</span><br><span class="line">nslookup kubernetes</span><br><span class="line">nslookup example-service</span><br><span class="line">curl example-service</span><br></pre></td></tr></table></figure>
<h1 id="9-负载组件切换"><a href="#9-负载组件切换" class="headerlink" title="9 负载组件切换"></a>9 负载组件切换</h1><p>如果kube-proxy用iptables想切换到到ipvs可以直接修改kube-proxy configmap即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit configmap kube-proxy -n kube-system</span><br><span class="line">    ipvs:</span><br><span class="line">      minSyncPeriod: 0s</span><br><span class="line">      scheduler: &quot;&quot;</span><br><span class="line">      syncPeriod: 30s</span><br><span class="line">    kind: KubeProxyConfiguration</span><br><span class="line">    metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">    mode: &quot;ipvs&quot; # 加上这个或iptables</span><br><span class="line">    nodePortAddresses: null</span><br></pre></td></tr></table></figure></p>
<p>要重启kube-proxy的容器</p>
<h1 id="10-部署Kubernetes-Dashboard"><a href="#10-部署Kubernetes-Dashboard" class="headerlink" title="10 部署Kubernetes Dashboard"></a>10 部署Kubernetes Dashboard</h1><h2 id="10-1-获取yaml"><a href="#10-1-获取yaml" class="headerlink" title="10.1 获取yaml"></a>10.1 获取yaml</h2><p>下载官方提供的 Dashboard 组件部署的 yaml 文件<br>wget <a href="https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml" target="_blank" rel="noopener">https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml</a><br>​</p>
<h2 id="10-2-修改-yaml-文件"><a href="#10-2-修改-yaml-文件" class="headerlink" title="10.2 修改 yaml 文件"></a>10.2 修改 yaml 文件</h2><p>修改image 为国内地址：<br>k8s.gcr.io 修改为 registry.cn-hangzhou.aliyuncs.com/google_containers，后续所有 yaml 文件中，只要涉及到 image 的，都需要做同样的修改，因为国内 k8s.gcr.io 这个地址被墙了。</p>
<p>修改 yaml 文件中的 Dashboard Service，暴露服务使外部能够访问<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1jiqun</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="string">修改为</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31111</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure></p>
<h2 id="10-3-启动-Dashboard"><a href="#10-3-启动-Dashboard" class="headerlink" title="10.3 启动 Dashboard"></a>10.3 启动 Dashboard</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<h2 id="10-4-访问-Dashboard"><a href="#10-4-访问-Dashboard" class="headerlink" title="10.4 访问 Dashboard"></a>10.4 访问 Dashboard</h2><p>地址： https://<your-ip>:31111/</your-ip></p>
<p>或者访问如下地址：<br><a href="https://10.7.12.200:8443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy" target="_blank" rel="noopener">https://10.7.12.200:8443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy</a></p>
<h2 id="10-5-创建能够访问-Dashboard-的用户"><a href="#10-5-创建能够访问-Dashboard-的用户" class="headerlink" title="10.5 创建能够访问 Dashboard 的用户"></a>10.5 创建能够访问 Dashboard 的用户</h2><p>新建文件 account.yaml ，内容如下：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create Service Account</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Create ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure></p>
<h2 id="10-6-获取登录-Dashboard-的令牌-（Token）"><a href="#10-6-获取登录-Dashboard-的令牌-（Token）" class="headerlink" title="10.6 获取登录 Dashboard 的令牌 （Token）"></a>10.6 获取登录 Dashboard 的令牌 （Token）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br></pre></td></tr></table></figure>
<p>输出如下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Name: admin-user-token-f6tct</span><br><span class="line">Namespace: kube-system</span><br><span class="line">Labels: &lt;none&gt;</span><br><span class="line">Annotations: kubernetes.io/service-account.name=admin-user</span><br><span class="line">              kubernetes.io/service-account.uid=81cb9047-7087-11e8-95da-00163e0c5bd1</span><br><span class="line">​</span><br><span class="line">Type: kubernetes.io/service-account-token</span><br><span class="line">​</span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt: 1025 bytes</span><br><span class="line">namespace: 11 bytes</span><br><span class="line">token: &lt;超长字符串&gt;</span><br></pre></td></tr></table></figure></p>
<p>参考文档:  </p>
<p><a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/install-kubeadm/</a></p>
<p><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/</a></p>
<p><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/</a></p>
<p><a href="https://kubernetes.io/docs/setup/independent/high-availability/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/high-availability/</a></p>
<p><a href="https://sealyun.com/post/k8s-ipvs/" target="_blank" rel="noopener">https://sealyun.com/post/k8s-ipvs/</a></p>
<p><a href="https://www.maogx.win/posts/33/" target="_blank" rel="noopener">https://www.maogx.win/posts/33/</a></p>
<p><a href="https://www.jianshu.com/p/31bee0cecaf2" target="_blank" rel="noopener">https://www.jianshu.com/p/31bee0cecaf2</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag"># k8s</a>
          
            <a href="/tags/kubeadm/" rel="tag"># kubeadm</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/24/linux/安全/iptables/" rel="next" title="iptables">
                <i class="fa fa-chevron-left"></i> iptables
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/24/k8s/registry/registryv2/搭建registry仓库/" rel="prev" title="搭建registry仓库">
                搭建registry仓库 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/ingress.png" alt="Peng Liu">
          <p class="site-author-name" itemprop="name">Peng Liu</p>
           
              <p class="site-description motion-element" itemprop="description">搬砖爱好者</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">136</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">21</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">88</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/liupeng0518" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/liupeng0518" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                    
                      Twitter
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/youngmario" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      微博
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/mario007" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                    
                      知乎
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-实验环境说明"><span class="nav-number">1.</span> <span class="nav-text">1 实验环境说明</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-基础环境配置"><span class="nav-number">2.</span> <span class="nav-text">2 基础环境配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-安装docker"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 安装docker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-配置国内-docker-镜像加速器"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 配置国内 docker 镜像加速器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-安装-kube-所有节点"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 安装 kube* (所有节点)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-基础系统参数配置"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 基础系统参数配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-高可用组件配置"><span class="nav-number">3.</span> <span class="nav-text">3 高可用组件配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-haproxy配置"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 haproxy配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#拉取镜像并修改haproxy配置"><span class="nav-number">3.1.1.</span> <span class="nav-text">拉取镜像并修改haproxy配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动并查看服务状态"><span class="nav-number">3.1.2.</span> <span class="nav-text">启动并查看服务状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-keepalived-配置"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 keepalived 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#拉取并启动服务"><span class="nav-number">3.2.1.</span> <span class="nav-text">拉取并启动服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看keepalived服务状态"><span class="nav-number">3.2.2.</span> <span class="nav-text">查看keepalived服务状态</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-配置启动kubelet"><span class="nav-number">4.</span> <span class="nav-text">4 配置启动kubelet</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-部署集群"><span class="nav-number">5.</span> <span class="nav-text">5 部署集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-配置第一个master节点"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 配置第一个master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成-kubeadm-需要的配置文件"><span class="nav-number">5.1.1.</span> <span class="nav-text">生成 kubeadm 需要的配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化"><span class="nav-number">5.1.2.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打包ca证书到其他master节点"><span class="nav-number">5.1.3.</span> <span class="nav-text">打包ca证书到其他master节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-配置第二个master节点"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 配置第二个master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成-kubeadm-需要的配置文件-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">生成 kubeadm 需要的配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置kubelet"><span class="nav-number">5.2.2.</span> <span class="nav-text">配置kubelet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加etcd到集群中"><span class="nav-number">5.2.3.</span> <span class="nav-text">添加etcd到集群中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置master加入集群"><span class="nav-number">5.2.4.</span> <span class="nav-text">配置master加入集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-3-配置第三个master节点"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 配置第三个master节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成-kubeadm-需要的配置文件-2"><span class="nav-number">5.3.1.</span> <span class="nav-text">生成 kubeadm 需要的配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置kubelet-1"><span class="nav-number">5.3.2.</span> <span class="nav-text">配置kubelet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加etcd到集群中-1"><span class="nav-number">5.3.3.</span> <span class="nav-text">添加etcd到集群中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置master加入集群-1"><span class="nav-number">5.3.4.</span> <span class="nav-text">配置master加入集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-4-查看node节点"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 查看node节点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-5-设置master为可调度状态"><span class="nav-number">5.5.</span> <span class="nav-text">5.5 设置master为可调度状态</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#6-网络插件部署"><span class="nav-number">6.</span> <span class="nav-text">6 网络插件部署</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-配置使用网络插件"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 配置使用网络插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-下载配置"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 下载配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-修改配置"><span class="nav-number">6.3.</span> <span class="nav-text">6.3 修改配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-4-启动并查看"><span class="nav-number">6.4.</span> <span class="nav-text">6.4 启动并查看</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#7-添加node节点"><span class="nav-number">7.</span> <span class="nav-text">7 添加node节点</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#8-集群基础环境测试"><span class="nav-number">8.</span> <span class="nav-text">8 集群基础环境测试</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-负载组件切换"><span class="nav-number">9.</span> <span class="nav-text">9 负载组件切换</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#10-部署Kubernetes-Dashboard"><span class="nav-number">10.</span> <span class="nav-text">10 部署Kubernetes Dashboard</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#10-1-获取yaml"><span class="nav-number">10.1.</span> <span class="nav-text">10.1 获取yaml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-2-修改-yaml-文件"><span class="nav-number">10.2.</span> <span class="nav-text">10.2 修改 yaml 文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-3-启动-Dashboard"><span class="nav-number">10.3.</span> <span class="nav-text">10.3 启动 Dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-4-访问-Dashboard"><span class="nav-number">10.4.</span> <span class="nav-text">10.4 访问 Dashboard</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-5-创建能够访问-Dashboard-的用户"><span class="nav-number">10.5.</span> <span class="nav-text">10.5 创建能够访问 Dashboard 的用户</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-6-获取登录-Dashboard-的令牌-（Token）"><span class="nav-number">10.6.</span> <span class="nav-text">10.6 获取登录 Dashboard 的令牌 （Token）</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Peng Liu</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>




        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
